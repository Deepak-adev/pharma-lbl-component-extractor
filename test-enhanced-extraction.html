<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Component Extraction Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-container { max-width: 800px; margin: 0 auto; }
        .upload-area { border: 2px dashed #ccc; padding: 40px; text-align: center; margin: 20px 0; }
        .results { margin-top: 20px; }
        .component { border: 1px solid #ddd; margin: 10px 0; padding: 10px; border-radius: 5px; }
        .component img { max-width: 200px; max-height: 150px; }
        .progress { background: #f0f0f0; height: 20px; border-radius: 10px; margin: 10px 0; }
        .progress-bar { background: #007bff; height: 100%; border-radius: 10px; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üöÄ Enhanced Component Extraction Test</h1>
        <p>Test the new advanced AI + Computer Vision component extraction algorithm</p>
        
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <p>üìÅ Click to upload pharmaceutical marketing materials</p>
            <p><small>Supports: PDF, JPG, PNG (1-15 files)</small></p>
            <input type="file" id="fileInput" multiple accept=".pdf,.jpg,.jpeg,.png" style="display: none;">
        </div>
        
        <div id="progress" style="display: none;">
            <h3>üîç Extraction Progress</h3>
            <div class="progress">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
            <p id="progressText">Starting extraction...</p>
        </div>
        
        <div id="results" class="results" style="display: none;">
            <h3>üìä Extraction Results</h3>
            <div id="componentsList"></div>
        </div>
    </div>

    <script type="module">
        import { advancedExtractionService } from './services/advancedExtractionService.js';
        import { enhancedAnalyzeAndCategorizeImage } from './services/enhancedGeminiService.js';

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            console.log(`üöÄ Starting enhanced extraction for ${files.length} files`);
            
            document.getElementById('progress').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            
            const allComponents = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const progress = ((i + 1) / files.length) * 100;
                
                document.getElementById('progressBar').style.width = `${progress}%`;
                document.getElementById('progressText').textContent = `üîç Analyzing ${file.name}...`;
                
                try {
                    // Convert file to base64
                    const base64 = await fileToBase64(file);
                    
                    // Run enhanced extraction
                    const components = await enhancedAnalyzeAndCategorizeImage(base64, file.type || 'image/jpeg');
                    
                    console.log(`‚úÖ Found ${components.length} components in ${file.name}`);
                    allComponents.push(...components.map(c => ({ ...c, sourceFile: file.name })));
                    
                } catch (error) {
                    console.error(`‚ùå Failed to process ${file.name}:`, error);
                }
            }
            
            // Show results
            document.getElementById('progress').style.display = 'none';
            document.getElementById('results').style.display = 'block';
            
            displayResults(allComponents);
        });

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function displayResults(components) {
            const container = document.getElementById('componentsList');
            container.innerHTML = '';
            
            if (components.length === 0) {
                container.innerHTML = '<p>‚ùå No components found. Try different files.</p>';
                return;
            }
            
            // Group by category
            const grouped = components.reduce((acc, comp) => {
                if (!acc[comp.category]) acc[comp.category] = [];
                acc[comp.category].push(comp);
                return acc;
            }, {});
            
            // Display summary
            const summary = document.createElement('div');
            summary.innerHTML = `
                <h4>üìà Summary</h4>
                <p><strong>Total Components:</strong> ${components.length}</p>
                <p><strong>Categories Found:</strong> ${Object.keys(grouped).length}</p>
                <p><strong>Category Breakdown:</strong></p>
                <ul>
                    ${Object.entries(grouped).map(([cat, comps]) => 
                        `<li>${cat}: ${comps.length} components</li>`
                    ).join('')}
                </ul>
            `;
            container.appendChild(summary);
            
            // Display components by category
            Object.entries(grouped).forEach(([category, categoryComponents]) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.innerHTML = `
                    <h4>üì¶ ${category} (${categoryComponents.length})</h4>
                `;
                
                categoryComponents.forEach((comp, index) => {
                    const compDiv = document.createElement('div');
                    compDiv.className = 'component';
                    compDiv.innerHTML = `
                        <h5>${comp.name}</h5>
                        <p><strong>Description:</strong> ${comp.description}</p>
                        <p><strong>Source:</strong> ${comp.sourceFile}</p>
                        <p><strong>Bounding Box:</strong> x:${comp.boundingBox.x.toFixed(1)}%, y:${comp.boundingBox.y.toFixed(1)}%, w:${comp.boundingBox.width.toFixed(1)}%, h:${comp.boundingBox.height.toFixed(1)}%</p>
                    `;
                    categoryDiv.appendChild(compDiv);
                });
                
                container.appendChild(categoryDiv);
            });
        }
    </script>
</body>
</html>